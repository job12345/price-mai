<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบคำนวณไหม - อัครพงษ์ฟาร์ม</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #f0fff4, #ffffff, #f0fff4);
        }
        .fade-in {
            animation: fadeIn 0.6s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .result-fade-in {
            animation: resultFadeIn 0.4s ease-in-out;
        }
        @keyframes resultFadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <div class="container mx-auto flex flex-col items-center p-4">
        <h1 class="text-2xl font-bold text-green-700 text-center mb-4 fade-in">
            ระบบคำนวณ % ไหม และราคาซื้อ<br />อัครพงษ์ ฟาร์ม
        </h1>

        <div class="w-full max-w-md bg-white shadow-xl rounded-2xl mb-6">
            <div class="p-6 space-y-4">
                <div>
                    <label class="block mb-1 text-sm font-medium text-gray-700">ชื่อผู้ใช้งาน</label>
                    <input id="userName" type="text" placeholder="กรุณากรอกชื่อของคุณ" class="w-full p-2 border border-gray-300 rounded-md">
                </div>

                <div>
                    <label class="block mb-1 text-sm font-medium text-gray-700">จำนวนรังที่สุ่ม (รัง)</label>
                    <input id="numRand" type="number" placeholder="กรอกจำนวนรัง" class="w-full p-2 border border-gray-300 rounded-md">
                </div>

                <div>
                    <label class="block mb-1 text-sm font-medium text-gray-700">น้ำหนักรังรวม (กรัม)</label>
                    <input id="totalWeight" type="number" placeholder="กรอกน้ำหนักรวม" class="w-full p-2 border border-gray-300 rounded-md">
                </div>

                <div>
                    <label class="block mb-1 text-sm font-medium text-gray-700">น้ำหนักตัวไหม (กรัม)</label>
                    <input id="silkwormWeight" type="number" placeholder="กรอกน้ำหนักตัวไหม" class="w-full p-2 border border-gray-300 rounded-md">
                </div>

                <div>
                    <label class="block mb-1 text-sm font-medium text-gray-700">น้ำหนักเปลือกรัง (กรัม)</label>
                    <input id="cocoonShellWeight" type="number" placeholder="กรอกน้ำหนักเปลือกรัง" class="w-full p-2 border border-gray-300 rounded-md">
                </div>

                <div>
                    <label class="block mb-1 text-sm font-medium text-gray-700">น้ำหนักรังดีที่จะขาย (กิโลกรัม)</label>
                    <input id="goodCocoonWeight" type="number" placeholder="กรอกน้ำหนักรังดี" class="w-full p-2 border border-gray-300 rounded-md">
                </div>

                <div>
                    <label class="block mb-1 text-sm font-medium text-gray-700">น้ำหนักรังเสีย (กิโลกรัม)</label>
                    <input id="badCocoonWeight" type="number" placeholder="กรอกน้ำหนักรังเสีย" class="w-full p-2 border border-gray-300 rounded-md">
                </div>

                <div>
                    <label class="block mb-1 text-sm font-medium text-gray-700">น้ำหนักรังหลังจ่อ (กิโลกรัม)</label>
                    <input id="afterSortWeight" type="number" placeholder="กรอกน้ำหนักรังหลังจ่อ" class="w-full p-2 border border-gray-300 rounded-md">
                </div>

                <div>
                    <label class="block mb-1 text-sm font-medium text-gray-700">น้ำหนักรังฝ่อ (กิโลกรัม)</label>
                    <input id="undevelopedWeight" type="number" placeholder="กรอกน้ำหนักรังฝ่อ" class="w-full p-2 border border-gray-300 rounded-md">
                </div>

                <div>
                    <label class="block mb-1 text-sm font-medium text-gray-700">น้ำหนักรังบาง (กิโลกรัม)</label>
                    <input id="thinWeight" type="number" placeholder="กรอกน้ำหนักรังบาง" class="w-full p-2 border border-gray-300 rounded-md">
                </div>

                <div>
                    <label class="block mb-1 text-sm font-medium text-gray-700">จำนวนกล่องที่เลี้ยง</label>
                    <input id="boxCount" type="number" placeholder="กรอกจำนวนกล่อง" class="w-full p-2 border border-gray-300 rounded-md">
                </div>

                <div id="resultPanel" class="p-4 bg-green-50 border border-green-200 rounded-xl text-center result-fade-in">
                    <div id="resultUserName" class="mb-2 font-medium text-green-800">
                        ผลการคำนวณ
                    </div>
                    <p class="text-lg font-semibold text-green-700">% เปลือกรังไหม: <span id="shellPercentage">0.00</span>%</p>
                    <p class="text-gray-600 mt-1">น้ำหนักรังเฉลี่ย: <span id="avgWeight">0.00</span> กรัม/รัง</p>
                    <p class="text-gray-600 mt-1">ราคารับซื้อรังดี: <span id="pricePerKg">0.00</span> บาท/กก.</p>
                    <p class="text-gray-600 mt-1">รายได้จากรังดี ≈ <span id="goodIncome">0.00</span> บาท</p>
                    <p class="text-gray-600 mt-1">รายได้จากรังเสีย ≈ <span id="badIncome">0.00</span> บาท</p>
                    <p class="text-gray-800 mt-2 font-bold">รายได้รวมทั้งหมด ≈ <span id="totalIncome">0.00</span> บาท</p>
                    <p class="text-green-700 mt-2 font-semibold border-t border-green-200 pt-2">รายได้ต่อกล่อง ≈ <span id="incomePerBox">0.00</span> บาท/กล่อง</p>
                </div>

                <div class="flex flex-col space-y-2 mt-4">
                    <button 
                        id="toggleShareBtn"
                        class="w-full py-2.5 px-4 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition-colors"
                    >
                        แชร์ผลการคำนวณ
                    </button>
                    
                    <div id="shareOptions" class="mt-2 flex flex-col space-y-2 hidden">
                        <button 
                            id="facebookShareBtn"
                            class="py-2 px-4 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg flex items-center justify-center transition-colors"
                        >
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm3 8h-1.35c-.538 0-.65.221-.65.778v1.222h2l-.209 2h-1.791v7h-3v-7h-2v-2h2v-2.308c0-1.769.931-2.692 3.029-2.692h1.971v3z" />
                            </svg>
                            แชร์ไปยัง Facebook
                        </button>
                        
                        <button 
                            id="lineShareBtn"
                            class="py-2 px-4 bg-green-500 hover:bg-green-600 text-white font-medium rounded-lg flex items-center justify-center transition-colors"
                        >
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M19.365 9.863c.349 0 .63.285.63.631 0 .345-.281.63-.63.63H17.61v1.125h1.755c.349 0 .63.283.63.63 0 .344-.281.629-.63.629h-2.386c-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63h2.386c.346 0 .627.285.627.63 0 .349-.281.63-.63.63H17.61v1.125h1.755zm-3.855 3.016c0 .27-.174.51-.433.596-.065.021-.132.031-.2.031-.211 0-.391-.09-.51-.25l-2.443-3.317v2.94c0 .344-.279.629-.631.629-.346 0-.626-.285-.626-.629V8.108c0-.27.173-.51.433-.595.064-.022.131-.032.199-.032.211 0 .391.09.51.25l2.444 3.317V8.108c0-.345.282-.63.63-.63.345 0 .627.285.627.63v4.771zm-5.741 0c0 .344-.282.629-.631.629-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63.346 0 .628.285.628.63v4.771zm-2.466.629H4.917c-.345 0-.63-.285-.63-.629V8.108c0-.345.285-.63.63-.63.348 0 .63.285.63.63v4.141h1.756c.348 0 .629.283.629.63 0 .344-.282.629-.629.629M24 10.314C24 4.943 18.615.572 12 .572S0 4.943 0 10.314c0 4.811 4.27 8.842 10.035 9.608.391.082.923.258 1.058.59.12.301.079.766.038 1.066l-.164 1.02c-.045.301-.24 1.186 1.049.645 1.291-.539 6.916-4.078 9.436-6.975C23.176 14.393 24 12.458 24 10.314"></path>
                            </svg>
                            แชร์ไปยัง Line
                        </button>
                        
                        <button 
                            id="whatsappShareBtn"
                            class="py-2 px-4 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg flex items-center justify-center transition-colors"
                        >
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.501-.669-.51l-.57-.01c-.198 0-.52.074-.792.372s-1.04 1.016-1.04 2.479 1.065 2.876 1.213 3.074c.149.198 2.095 3.2 5.076 4.487.709.306 1.263.489 1.694.626.712.226 1.36.194 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z" />
                            </svg>
                            แชร์ไปยัง WhatsApp
                        </button>
                        
                        <button 
                            id="saveImageBtn"
                            class="py-2 px-4 bg-gray-700 hover:bg-gray-800 text-white font-medium rounded-lg flex items-center justify-center transition-colors"
                        >
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            บันทึกเป็นรูปภาพ
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="text-xs text-gray-500 mt-4 text-center">
            &copy; <span id="currentYear"></span> อัครพงษ์ฟาร์ม - ระบบคำนวณไหม เวอร์ชัน 1.0
        </div>
        
        <div class="flex justify-center mt-3 mb-2">
            <a href="https://www.freecounterstat.com" title="free hit counter" target="_blank" class="inline-block">
                <img src="https://counter1.optistats.ovh/private/freecounterstat.php?c=kuzmwxk24dmnd2qcg6zmzw9dc2puc5hb" border="0" title="free hit counter" alt="free hit counter">
            </a>
        </div>
    </div>

    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Set current year
            document.getElementById('currentYear').textContent = new Date().getFullYear();

            // Input elements
            const userName = document.getElementById('userName');
            const numRand = document.getElementById('numRand');
            const totalWeight = document.getElementById('totalWeight');
            const silkwormWeight = document.getElementById('silkwormWeight');
            const cocoonShellWeight = document.getElementById('cocoonShellWeight');
            const goodCocoonWeight = document.getElementById('goodCocoonWeight');
            const badCocoonWeight = document.getElementById('badCocoonWeight');
            const afterSortWeight = document.getElementById('afterSortWeight');
            const undevelopedWeight = document.getElementById('undevelopedWeight');
            const thinWeight = document.getElementById('thinWeight');
            const boxCount = document.getElementById('boxCount');

            // Result elements
            const resultUserName = document.getElementById('resultUserName');
            const shellPercentage = document.getElementById('shellPercentage');
            const avgWeight = document.getElementById('avgWeight');
            const pricePerKg = document.getElementById('pricePerKg');
            const goodIncome = document.getElementById('goodIncome');
            const badIncome = document.getElementById('badIncome');
            const totalIncome = document.getElementById('totalIncome');
            const incomePerBox = document.getElementById('incomePerBox');

            // Share buttons
            const toggleShareBtn = document.getElementById('toggleShareBtn');
            const shareOptions = document.getElementById('shareOptions');
            const facebookShareBtn = document.getElementById('facebookShareBtn');
            const lineShareBtn = document.getElementById('lineShareBtn');
            const saveImageBtn = document.getElementById('saveImageBtn');

            // Format number function
            const formatNumber = (num) => {
                return num.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            };

            // Calculate function
            const calculate = () => {
                // User name
                resultUserName.textContent = userName.value ? `ผลการคำนวณของคุณ ${userName.value}` : 'ผลการคำนวณ';

                // Get values
                const numRandVal = parseFloat(numRand.value) || 0;
                const totalWeightVal = parseFloat(totalWeight.value) || 0;
                const silkwormWeightVal = parseFloat(silkwormWeight.value) || 0;
                let cocoonShellWeightVal = parseFloat(cocoonShellWeight.value) || 0;
                const goodCocoonWeightVal = parseFloat(goodCocoonWeight.value) || 0;
                const badCocoonWeightVal = parseFloat(badCocoonWeight.value) || 0;
                const afterSortWeightVal = parseFloat(afterSortWeight.value) || 0;
                const undevelopedWeightVal = parseFloat(undevelopedWeight.value) || 0;
                const thinWeightVal = parseFloat(thinWeight.value) || 0;

                // Calculate shell weight if not provided
                if (!cocoonShellWeightVal && totalWeightVal && silkwormWeightVal) {
                    cocoonShellWeightVal = totalWeightVal - silkwormWeightVal;
                }

                // Calculate percentage
                let percent = 0;
                if (totalWeightVal > 0) {
                    percent = (cocoonShellWeightVal / totalWeightVal) * 100;
                }

                // Calculate average weight
                let avg = 0;
                if (numRandVal > 0) {
                    avg = totalWeightVal / numRandVal;
                }

                // Price based on shell percentage
                let price = 0;
                const rounded = Math.round(percent);
                if (rounded <= 16) price = 200;
                else if (rounded === 17) price = 212.5;
                else if (rounded === 18) price = 225;
                else if (rounded === 19) price = 237.5;
                else if (rounded === 20) price = 250;
                else if (rounded === 21) price = 262.5;
                else if (rounded === 22) price = 275;
                else if (rounded === 23) price = 287.5;
                else if (rounded === 24) price = 300;
                else if (rounded === 25) price = 312.5;
                else if (rounded >= 26) price = 325;

                // Calculate income
                const goodIncomeVal = goodCocoonWeightVal * price;
                const badIncomeVal = (badCocoonWeightVal * 140) + (afterSortWeightVal * 140) + (undevelopedWeightVal * 140) + (thinWeightVal * 25);
                const totalIncomeVal = goodIncomeVal + badIncomeVal;
                
                // Calculate income per box
                const boxCountVal = parseFloat(boxCount.value) || 1; // ใช้ค่า 1 ถ้าไม่ได้กรอก
                const incomePerBoxVal = totalIncomeVal / boxCountVal;

                // Update results
                shellPercentage.textContent = formatNumber(percent);
                avgWeight.textContent = formatNumber(avg);
                pricePerKg.textContent = formatNumber(price);
                goodIncome.textContent = formatNumber(goodIncomeVal);
                badIncome.textContent = formatNumber(badIncomeVal);
                totalIncome.textContent = formatNumber(totalIncomeVal);
                incomePerBox.textContent = formatNumber(incomePerBoxVal);
            };

            // Add event listeners to all inputs
            [numRand, totalWeight, silkwormWeight, cocoonShellWeight, goodCocoonWeight, 
             badCocoonWeight, afterSortWeight, undevelopedWeight, thinWeight, boxCount].forEach(input => {
                input.addEventListener('input', calculate);
            });

            // User name change event
            userName.addEventListener('input', calculate);

            // Share options toggle
            toggleShareBtn.addEventListener('click', () => {
                const isHidden = shareOptions.classList.contains('hidden');
                if (isHidden) {
                    shareOptions.classList.remove('hidden');
                    toggleShareBtn.textContent = 'ซ่อนตัวเลือกการแชร์';
                } else {
                    shareOptions.classList.add('hidden');
                    toggleShareBtn.textContent = 'แชร์ผลการคำนวณ';
                }
            });

            // Facebook share
            facebookShareBtn.addEventListener('click', () => {
                const resultPanel = document.getElementById('resultPanel');
                html2canvas(resultPanel).then(canvas => {
                    // แปลงรูปภาพเป็น Base64
                    const imageData = canvas.toDataURL("image/png");
                    const userMessage = `ผลการคำนวณรังไหมของ ${userName.value || 'ผู้ใช้งาน'} - อัครพงษ์ฟาร์ม`;
                    
                    // ใช้ URI scheme ของ Facebook app โดยตรง
                    const fbAppUrl = `fb://share?text=${encodeURIComponent(userMessage)}`;
                    
                    // พยายามเปิด app ก่อน ถ้าไม่สำเร็จให้เปิดผ่านเบราว์เซอร์แทน
                    try {
                        window.location.href = fbAppUrl;
                        
                        // ถ้าหลังจาก 2 วินาทียังอยู่ในหน้าเดิม แสดงว่าไม่มีแอพ Facebook ติดตั้ง
                        setTimeout(() => {
                            const facebookShareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(window.location.href)}&quote=${encodeURIComponent(userMessage)}`;
                            window.open(facebookShareUrl, "_blank");
                        }, 2000);
                    } catch (e) {
                        // กรณีเกิดข้อผิดพลาด ให้เปิดผ่านเบราว์เซอร์แทน
                        const facebookShareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(window.location.href)}&quote=${encodeURIComponent(userMessage)}`;
                        window.open(facebookShareUrl, "_blank");
                    }
                });
            });

            // Line share
            lineShareBtn.addEventListener('click', () => {
                const resultPanel = document.getElementById('resultPanel');
                html2canvas(resultPanel).then(canvas => {
                    const imageData = canvas.toDataURL("image/png");
                    const userMessage = `ผลการคำนวณรังไหมของ ${userName.value || 'ผู้ใช้งาน'} - อัครพงษ์ฟาร์ม`;
                    
                    // ใช้ URI scheme ของ Line app โดยตรง
                    const lineAppUrl = `line://msg/text/${encodeURIComponent(userMessage)}`;
                    
                    // พยายามเปิด app ก่อน ถ้าไม่สำเร็จให้เปิดผ่านเบราว์เซอร์แทน
                    try {
                        window.location.href = lineAppUrl;
                        
                        // ถ้าหลังจาก 2 วินาทียังอยู่ในหน้าเดิม แสดงว่าไม่มีแอพ Line ติดตั้ง
                        setTimeout(() => {
                            const lineShareUrl = `https://line.me/R/msg/text/?${encodeURIComponent(userMessage)}`;
                            window.open(lineShareUrl, "_blank");
                        }, 2000);
                    } catch (e) {
                        // กรณีเกิดข้อผิดพลาด ให้เปิดผ่านเบราว์เซอร์แทน
                        const lineShareUrl = `https://line.me/R/msg/text/?${encodeURIComponent(userMessage)}`;
                        window.open(lineShareUrl, "_blank");
                    }
                });
            });

            // Save image
            saveImageBtn.addEventListener('click', () => {
                const resultPanel = document.getElementById('resultPanel');
                html2canvas(resultPanel).then(canvas => {
                    // สำหรับอุปกรณ์ iOS บางรุ่น จำเป็นต้องใช้วิธีนี้
                    if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
                        // แสดงรูปภาพในหน้าต่างใหม่เพื่อให้กดค้างที่รูปเพื่อบันทึกได้
                        const imageWindow = window.open('');
                        imageWindow.document.write('<img src="' + canvas.toDataURL("image/png") + '" alt="ผลการคำนวณไหม"/>');
                        imageWindow.document.write('<p>กดค้างที่รูปภาพเพื่อบันทึก</p>');
                        return;
                    }
                    
                    // สำหรับ Android และ Desktop
                    const imageData = canvas.toDataURL("image/png");
                    const link = document.createElement("a");
                    link.href = imageData;
                    link.download = `ผลการคำนวณไหม-${userName.value || 'ผู้ใช้งาน'}.png`;
                    link.click();
                });
            });
            
            // WhatsApp share
            const whatsappShareBtn = document.getElementById('whatsappShareBtn');
            whatsappShareBtn.addEventListener('click', () => {
                const resultPanel = document.getElementById('resultPanel');
                html2canvas(resultPanel).then(canvas => {
                    const userMessage = `ผลการคำนวณรังไหมของ ${userName.value || 'ผู้ใช้งาน'} - อัครพงษ์ฟาร์ม`;
                    
                    // ใช้ URI scheme ของ WhatsApp app โดยตรง
                    const whatsappAppUrl = `whatsapp://send?text=${encodeURIComponent(userMessage)}`;
                    
                    // พยายามเปิด app ก่อน ถ้าไม่สำเร็จให้เปิดผ่านเบราว์เซอร์แทน
                    try {
                        window.location.href = whatsappAppUrl;
                        
                        // ถ้าหลังจาก 2 วินาทียังอยู่ในหน้าเดิม แสดงว่าไม่มีแอพ WhatsApp ติดตั้ง
                        setTimeout(() => {
                            const whatsappWebUrl = `https://web.whatsapp.com/send?text=${encodeURIComponent(userMessage)}`;
                            window.open(whatsappWebUrl, "_blank");
                        }, 2000);
                    } catch (e) {
                        // กรณีเกิดข้อผิดพลาด ให้เปิดผ่านเบราว์เซอร์แทน
                        const whatsappWebUrl = `https://web.whatsapp.com/send?text=${encodeURIComponent(userMessage)}`;
                        window.open(whatsappWebUrl, "_blank");
                    }
                });
            });

            // Initial calculation
            calculate();
        });
    </script>
</body>
</html>
